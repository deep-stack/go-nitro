<h1 align="center">
<div><img src="https://statechannels.org/favicon.ico"><br>
go-nitro
</h1>

<p align="center">Implementation of the <a href="https://docs.statechannels.org">Nitro State Channels Framework</a> in Golang and Solidity.</p>

`go-nitro` is an implementation of a node in a nitro state channel network. It is software that:

- manages a secret "channel" key
- crafts blockchain transactions (to allow the user to join and exit the network)
- crafts, signs, and sends state channel updates to counterparties in the network
- listens to blockchain events
- listens for counterparty messages
- stores important data to allow for recovery from counterparty inactivity / malice
- understands how to perform these functions safely, without risking any funds

## Usage

> ⚠️ Go-nitro is pre-production software ⚠️

Go-nitro can be consumed either as [library code](./node/readme.md) or run as an [independent process](./doc.go) and interfaced with remote procedure calls (recommended).

## Contributing

Please see [contributing.md](./contributing.md)

## ADRs

Architectural decision records may be viewed [here](./.adr/0000-adrs.md).

## Testing

> Pre-requisite: [generate a TLS certificate](./tls/readme.md)

Run the tests from repo root:

```
go test ./... -count=2 -shuffle=on -timeout 1m -v -failfast
```

## On-chain code

The on-chain component of Nitro (i.e. the solidity contracts) are housed in the [`nitro-protocol`](./packages/nitro-protocol/readme.md) directory. This directory contains an yarn workspace with a hardhat / typechain / jest toolchain.

## Steps to perform payments between two go-nitro nodes

- Follow this [doc](https://book.getfoundry.sh/getting-started/installation) to set up foundry to run anvil chain

  - Use an older foundry version to work with go-nitro

    ```bash
    foundryup --version nightly-cafc2606a2187a42b236df4aa65f4e8cdfcea970
    ```

- Start anvil chain:

  ```bash
  anvil  --chain-id 1337 --block-time 1
  ```

- Install dependencies

  ```bash
  yarn
  ```

- Deploy the Nitro protocol contracts:

  - Change directory to `nitro-protocol`

    ```bash
    cd packages/nitro-protocol
    ```

  - Deploy nitro contracts

    ```bash
    yarn contracts:deploy-localhost
    ```

    Note: On restarting the chain, make sure to remove `packages/nitro-protocol/hardhat-deployments` when redeploying contracts

    ```bash
    rm -rf hardhat-deployments
    ```

  - Change directory to root directory

    ```bash
    cd ../../
    ```

- Generate TLS certificate

  - Change directory to `tls`

    ```bash
    cd tls
    ```

  - Follow [README](tls/readme.md)

  - Change directory to root directory

    ```bash
    cd ../
    ```

- Run go-nitro node for Alice:

  - Load contract addresses from environment file to current shell session

    ```bash
    source packages/nitro-protocol/hardhat-deployments/localhost/.contracts.env
    ```

  - Run node for Alice

    ```bash
    export NITRO_CHAIN_URL=ws://127.0.0.1:8545
    export ALICE_ADDRESS=0xAAA6628Ec44A8a742987EF3A114dDFE2D4F7aDCE
    export ALICE_PK=2d999770f7b5d49b694080f987b82bbc9fc9ac2b4dcc10b0f8aba7d700f69c6d
    export ALICE_CHAIN_PK=ac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80

    go run . -chainurl ${NITRO_CHAIN_URL} -msgport 3006 -rpcport 4006 -pk $ALICE_PK -chainpk $ALICE_CHAIN_PK -naaddress $NA_ADDRESS -vpaaddress $VPA_ADDRESS -caaddress $CA_ADDRESS -tlskeyfilepath ./tls/statechannels.org_key.pem -tlscertfilepath ./tls/statechannels.org.pem
    ```

- Run go-nitro node for Bob in new terminal:

  - Load contract addresses from environment file to current shell session

    ```bash
    source packages/nitro-protocol/hardhat-deployments/localhost/.contracts.env
    ```

  - Run node for Bob

    ```bash
    export NITRO_CHAIN_URL=ws://127.0.0.1:8545
    export BOB_ADDRESS=0xBBB676f9cFF8D242e9eaC39D063848807d3D1D94
    export BOB_PK=0279651921cd800ac560c21ceea27aab0107b67daf436cdd25ce84cad30159b4
    export BOB_CHAIN_PK=59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d

    go run . -chainurl ${NITRO_CHAIN_URL} -msgport 3007 -rpcport 4007 -pk $BOB_PK -chainpk $BOB_CHAIN_PK -naaddress $NA_ADDRESS -vpaaddress $VPA_ADDRESS -caaddress $CA_ADDRESS  -bootpeers "/ip4/127.0.0.1/tcp/3006/p2p/16Uiu2HAmSjXJqsyBJgcBUU2HQmykxGseafSatbpq5471XmuaUqyv" -tlskeyfilepath ./tls/statechannels.org_key.pem -tlscertfilepath ./tls/statechannels.org.pem
    ```

    Note: Alice's P2P multiaddr is provided as bootpeer to Bob

- In a new terminal change directory to `packages/nitro-rpc-client`

  ```bash
  cd packages/nitro-rpc-client
  ```

- Set `NODE_EXTRA_CA_CERTS` environment variable to the path of a root certificate file (rootCA.pem) generated by mkcert

  ```bash
  export NODE_EXTRA_CA_CERTS="$(mkcert -CAROOT)/rootCA.pem"
  ```

- Create a ledger channel:

  ```bash
  npm exec -c 'nitro-rpc-client direct-fund 0xBBB676f9cFF8D242e9eaC39D063848807d3D1D94 -p 4006'
  ```

  Example output

  ```bash
  Objective started DirectFunding-0x16e30bfaa0a3ebcf1347ddcdd42df29dc960c75d0d3de530fb69ec0cbeebd8fa
  Channel Open 0x16e30bfaa0a3ebcf1347ddcdd42df29dc960c75d0d3de530fb69ec0cbeebd8fa
  ```

- Assign ledger channel id in output log above (`Channel Open <LEDGER_CHANNEL_ID>`) to an environment variable

  ```bash
  export LEDGER_CHANNEL_ID=<LEDGER_CHANNEL_ID>
  ```

- Check ledger channel info:

  ```bash
  npm exec -c 'nitro-rpc-client get-ledger-channel $LEDGER_CHANNEL_ID -p 4006'
  ```

  Example output

  ```bash
  {
    ID: '0xf6523e28b39de1e9afa65e2d29c23e22949d4d4ed55137cd208d035d4a88467f',
    Status: 'Open',
    Balance: {
      AssetAddress: '0x0000000000000000000000000000000000000000',
      Me: '0xaaa6628ec44a8a742987ef3a114ddfe2d4f7adce',
      Them: '0xbbb676f9cff8d242e9eac39d063848807d3d1d94',
      MyBalance: 1000000n,
      TheirBalance: 1000000n
    }
  }
  ```

- Create a virtual payment channel:

  ```bash
  npm exec -c 'nitro-rpc-client virtual-fund 0xBBB676f9cFF8D242e9eaC39D063848807d3D1D94 -p 4006'
  ```

  Example output

  ```bash
  Objective started VirtualFund-0x25676acc207865bd16c12eb4507784c0d1d3997945325a37e131d985a879bdab
  Channel Open 0x25676acc207865bd16c12eb4507784c0d1d3997945325a37e131d985a879bdab
  ```

- Assign payment channel id in output log above (`Channel Open <PAYMENT_CHANNEL_ID>`) to an environment variable

  ```bash
  export PAYMENT_CHANNEL_ID=<PAYMENT_CHANNEL_ID>
  ```

- Check ledger channel info:

  ```bash
  npm exec -c 'nitro-rpc-client get-ledger-channel $LEDGER_CHANNEL_ID -p 4006'
  ```

  Example output

  ```bash
  {
    ID: '0xdf27ffafa9fbdd5f06821a755a08982adfcdc8ea7bd12638b07c279672faf8b6',
    Status: 'Open',
    Balance: {
      AssetAddress: '0x0000000000000000000000000000000000000000',
      Me: '0xaaa6628ec44a8a742987ef3a114ddfe2d4f7adce',
      Them: '0xbbb676f9cff8d242e9eac39d063848807d3d1d94',
      MyBalance: 999000n,
      TheirBalance: 999000n
    }
  }
  ```

- Check virtual channel info:

  ```bash
  npm exec -c 'nitro-rpc-client get-payment-channel $PAYMENT_CHANNEL_ID -p 4006'
  ```

  Example output

  ```bash
  {
    ID: '0xc024a21a6c2626b100b9f4571e788f6c4ffedbd03ab7a2031d2db6929b375d4e',
    Status: 'Open',
    Balance: {
      AssetAddress: '0x0000000000000000000000000000000000000000',
      Payee: '0xbbb676f9cff8d242e9eac39d063848807d3d1d94',
      Payer: '0xaaa6628ec44a8a742987ef3a114ddfe2d4f7adce',
      PaidSoFar: 0n,
      RemainingFunds: 1000n
    }
  }
  ```

- Make payment from Alice to Bob:

  ```bash
  npm exec -c 'nitro-rpc-client pay $PAYMENT_CHANNEL_ID 50 -p 4006'
  ```

  Example output

  ```bash
  {
    Amount: 50,
    Channel: '0xc024a21a6c2626b100b9f4571e788f6c4ffedbd03ab7a2031d2db6929b375d4e'
  }
  ```

- Check virtual channel info:

  ```bash
  npm exec -c 'nitro-rpc-client get-payment-channel $PAYMENT_CHANNEL_ID -p 4006'
  ```

  Example output

  ```bash
  {
    ID: '0xc024a21a6c2626b100b9f4571e788f6c4ffedbd03ab7a2031d2db6929b375d4e',
    Status: 'Open',
    Balance: {
      AssetAddress: '0x0000000000000000000000000000000000000000',
      Payee: '0xbbb676f9cff8d242e9eac39d063848807d3d1d94',
      Payer: '0xaaa6628ec44a8a742987ef3a114ddfe2d4f7adce',
      PaidSoFar: 50n,
      RemainingFunds: 950n
    }
  }
  ```

- Close the virtual payment channel:

  ```bash
  npm exec -c 'nitro-rpc-client virtual-defund $PAYMENT_CHANNEL_ID -p 4006'
  ```

  Example output

  ```bash
  Objective started VirtualDefund-0xc024a21a6c2626b100b9f4571e788f6c4ffedbd03ab7a2031d2db6929b375d4e
  Channel complete 0xc024a21a6c2626b100b9f4571e788f6c4ffedbd03ab7a2031d2db6929b375d4e
  ```

- Check virtual channel info:

  ```bash
  npm exec -c 'nitro-rpc-client get-payment-channel $PAYMENT_CHANNEL_ID -p 4006'
  ```

  Example output

  ```bash
  {
    ID: '0xc024a21a6c2626b100b9f4571e788f6c4ffedbd03ab7a2031d2db6929b375d4e',
    Status: 'Complete',
    Balance: {
      AssetAddress: '0x0000000000000000000000000000000000000000',
      Payee: '0xbbb676f9cff8d242e9eac39d063848807d3d1d94',
      Payer: '0xaaa6628ec44a8a742987ef3a114ddfe2d4f7adce',
      PaidSoFar: 50n,
      RemainingFunds: 950n
    }
  }
  ```

- Check ledger channel info:

  ```bash
  npm exec -c 'nitro-rpc-client get-ledger-channel $LEDGER_CHANNEL_ID -p 4006'
  ```

  Example output

  ```bash
  {
    ID: '0xdf27ffafa9fbdd5f06821a755a08982adfcdc8ea7bd12638b07c279672faf8b6',
    Status: 'Open',
    Balance: {
      AssetAddress: '0x0000000000000000000000000000000000000000',
      Me: '0xaaa6628ec44a8a742987ef3a114ddfe2d4f7adce',
      Them: '0xbbb676f9cff8d242e9eac39d063848807d3d1d94',
      MyBalance: 999950n,
      TheirBalance: 1000050n
    }
  }
  ```

- Close the ledger channel:

  ```bash
  npm exec -c 'nitro-rpc-client direct-defund $LEDGER_CHANNEL_ID -p 4006'
  ```

- Check ledger channel info:

  ```bash
  npm exec -c 'nitro-rpc-client get-ledger-channel $LEDGER_CHANNEL_ID -p 4006'
  ```

  Example output

  ```bash
  {
    ID: '0xf6523e28b39de1e9afa65e2d29c23e22949d4d4ed55137cd208d035d4a88467f',
    Status: 'Complete',
    Balance: {
      AssetAddress: '0x0000000000000000000000000000000000000000',
      Me: '0xaaa6628ec44a8a742987ef3a114ddfe2d4f7adce',
      Them: '0xbbb676f9cff8d242e9eac39d063848807d3d1d94',
      MyBalance: 999950n,
      TheirBalance: 1000050n
    }
  }
  ```

- Check on chain balance for Alice

  ```bash
  echo $(
    printf "Result: %d" $(
      curl -sk -X POST -H "Content-Type: application/json" --data '{
        "jsonrpc":"2.0",
        "method":"eth_getBalance",
        "params": ["0xAAA6628Ec44A8a742987EF3A114dDFE2D4F7aDCE", "latest"],
        "id":1
      }' http://localhost:8545 | jq -r '.result'
    )
  )
  ```

  Example output

  ```bash
  Result: 999950
  ```

- Check on chain balance for Bob

  ```bash
  echo $(
    printf "Result: %d" $(
      curl -sk -X POST -H "Content-Type: application/json" --data '{
        "jsonrpc":"2.0",
        "method":"eth_getBalance",
        "params": ["0xBBB676f9cFF8D242e9eaC39D063848807d3D1D94", "latest"],
        "id":1
      }' http://localhost:8545 | jq -r '.result'
    )
  )
  ```

  Example output

  ```bash
  Result: 1000050
  ```

## Steps to retry dropped txs

### Direct fund

- Check status of direct-fund objective

  ```bash
  nitro-rpc-client get-objective <Objective ID> -p <RPC port of the L1 node>

  # Expected output:
  # {"Status":1,"C":"0xb08b6c111e9d0b0cb0ad31274132ac7e7542242e2a80201d9e9e5a2e78fe197d","MyDepositSafetyThreshold":{"0xcf7ed3acca5a467e9e704c703e8d87f634fb0fc9":0},"MyDepositTarget":{"0xcf7ed3acca5a467e9e704c703e8d87f634fb0fc9":1000000},"FullyFundedThreshold":{"0xcf7ed3acca5a467e9e704c703e8d87f634fb0fc9":2000000},"TransactionSumbmitted":true,"DroppedTx":{"DroppedTxHash":"0x339079c724690c6b99e15b5f04fc4e36ccdab30a83602734057c4e2f6fd04afe","ChannelId":"0xb08b6c111e9d0b0cb0ad31274132ac7e7542242e2a80201d9e9e5a2e78fe197d","EventName":"Deposited"}}
  ```

  - This will give you status of the objective, with dropped tx details if any

  - In the dropped tx details, you should see the trasaction that was dropped along with its `hash`, `channel ID`, and the `Event` associated with that tx

- You can retry the dropped tx using

  ```bash
  nitro-rpc-client retry-objective-tx <Objective ID> -p <RPC port of L1 node>
  ```

### Bridged fund

- To check status of bridged-fund objective, you either need objective Id of corresponding direct-fund objective (L1 objective) or objective ID of bridged-fund objective (L2 objective)

  - Using corresponding direct-fund objective (L1 objective)

    ```bash
    nitro-rpc-client get-l2-objective-from-l1 <L1 Objective ID> -p <RPC port of the bridge>
    ```

  - Using objective ID of bridged-fund

    ```bash
    nitro-rpc-client get-objective <Objective ID> --l2 true -p <RPC port of the bridge>
    ```

    ```bash
    nitro-rpc-client get-objective <Objective ID> -p <RPC port of L2 node>
    ```

  - This will give you status of the objective, with dropped tx details if any

- You can retry the dropped tx using

  ```bash
  nitro-rpc-client retry-objective-tx <Objective ID> -p <RPC port of the L2 node / bridge>
  ```

### Non-objective bridge txs

- Some txs that are performed by bridge are not part of any objective

- These txs are stored against channel ID

- To see if these txs are confirmed or not, we can query bridge to get the pending txs

  ```bash
  nitro-rpc-client get-pending-bridge-txs <Channel ID> -p <RPC port of the bridge>
  ```

- Txs are stored against both L1 and L2 channel IDs so please check both channels see if any txs are pending

- If these txs fail, bridge retries them until retry tx threshold has been met

  - if there are any txs with `isDropped: false`, that means they are not auto retried by bridge just yet

- If there are any txs with `isDropped: true`, it means these txs failed even after auto retry

- The `get-pending-txs` command will output pending txs details along with their tx hash

- To manually retry txs that failed after auto retry, use

  ```bash
  nitro-rpc-client retry-tx <Tx hash of the failed tx> -p <RPC port of the bridge>
  ```

## License

Dual-licensed under [MIT](https://opensource.org/licenses/MIT) + [Apache 2.0](http://www.apache.org/licenses/LICENSE-2.0)
